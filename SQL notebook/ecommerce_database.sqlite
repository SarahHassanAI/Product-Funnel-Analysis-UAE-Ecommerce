-- 1. See all data structure
SELECT * FROM users LIMIT 5;

-- 2. Count users by country
SELECT country, COUNT(*) as user_count 
FROM users 
GROUP BY country 
ORDER BY user_count DESC;

-- 3. Basic funnel metrics
SELECT 
    COUNT(DISTINCT u.user_id) as total_users,
    COUNT(DISTINCT s.session_id) as total_sessions,
    COUNT(DISTINCT o.order_id) as total_orders
FROM users u
LEFT JOIN sessions s ON u.user_id = s.user_id
LEFT JOIN orders o ON u.user_id = o.user_id;

-- 4. Revenue by country and device (Query 6)
SELECT 
    u.country,
    u.device_type,
    COUNT(DISTINCT o.order_id) as total_orders,
    SUM(o.total_amount) as total_revenue,
    ROUND(AVG(o.total_amount), 2) as average_order_value
FROM users u
JOIN orders o ON u.user_id = o.user_id
WHERE o.order_status = 'completed'
GROUP BY u.country, u.device_type
ORDER BY total_revenue DESC;

-- 5. Product performance (Query 7)
SELECT 
    p.product_id,
    p.product_name,
    p.category,
    p.price,
    COUNT(oi.order_item_id) as total_units_sold,
    SUM(oi.quantity * oi.unit_price) as total_revenue
FROM products p
JOIN order_items oi ON p.product_id = oi.product_id
JOIN orders o ON oi.order_id = o.order_id
WHERE o.order_status = 'completed'
GROUP BY p.product_id, p.product_name, p.category, p.price
ORDER BY total_revenue DESC
LIMIT 10;

-- 6. Funnel conversion rates (Query 5)
SELECT 
    COUNT(DISTINCT u.user_id) as total_users,
    COUNT(DISTINCT s.session_id) as users_with_sessions,
    COUNT(DISTINCT CASE WHEN a.action_type = 'add_to_cart' THEN a.user_id END) as users_added_to_cart,
    COUNT(DISTINCT o.user_id) as users_who_purchased,
    ROUND(COUNT(DISTINCT s.session_id) * 100.0 / COUNT(DISTINCT u.user_id), 2) as browse_rate,
    ROUND(COUNT(DISTINCT CASE WHEN a.action_type = 'add_to_cart' THEN a.user_id END) * 100.0 / COUNT(DISTINCT s.session_id), 2) as cart_rate,
    ROUND(COUNT(DISTINCT o.user_id) * 100.0 / COUNT(DISTINCT CASE WHEN a.action_type = 'add_to_cart' THEN a.user_id END), 2) as purchase_rate
FROM users u
LEFT JOIN sessions s ON u.user_id = s.user_id
LEFT JOIN user_actions a ON u.user_id = a.user_id
LEFT JOIN orders o ON u.user_id = o.user_id;

-- 7. Monthly trends (Query 8)
SELECT 
    STRFTIME('%Y-%m', o.order_date) as order_month,
    COUNT(DISTINCT o.order_id) as monthly_orders,
    SUM(o.total_amount) as monthly_revenue,
    COUNT(DISTINCT o.user_id) as monthly_customers
FROM orders o
WHERE o.order_status = 'completed'
GROUP BY STRFTIME('%Y-%m', o.order_date)
ORDER BY order_month;

-- 8. Customer segmentation by value
SELECT 
    u.user_id,
    u.country,
    COUNT(o.order_id) as order_count,
    SUM(o.total_amount) as lifetime_value,
    CASE 
        WHEN SUM(o.total_amount) > 1000 THEN 'VIP'
        WHEN SUM(o.total_amount) > 500 THEN 'Premium' 
        ELSE 'Standard'
    END as customer_tier
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
WHERE o.order_status = 'completed'
GROUP BY u.user_id, u.country
ORDER BY lifetime_value DESC
LIMIT 15;

-- 9. Cart abandonment analysis
SELECT 
    u.country,
    u.device_type,
    COUNT(DISTINCT CASE WHEN a.action_type = 'add_to_cart' THEN a.user_id END) as cart_adders,
    COUNT(DISTINCT CASE WHEN o.order_status = 'completed' THEN o.user_id END) as purchasers,
    ROUND((COUNT(DISTINCT CASE WHEN a.action_type = 'add_to_cart' THEN a.user_id END) - 
           COUNT(DISTINCT CASE WHEN o.order_status = 'completed' THEN o.user_id END)) * 100.0 / 
          COUNT(DISTINCT CASE WHEN a.action_type = 'add_to_cart' THEN a.user_id END), 2) as abandonment_rate
FROM users u
LEFT JOIN user_actions a ON u.user_id = a.user_id
LEFT JOIN orders o ON u.user_id = o.user_id
GROUP BY u.country, u.device_type
ORDER BY abandonment_rate DESC;
